generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum FundraiserStatus {
  ACTIVE
  CLOSED
}

enum ListingStatus {
  ACTIVE
  INACTIVE
}

enum MemorialVisibilityType {
  PUBLIC
  PRIVATE
  LINK_ONLY
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  fullName      String
  passwordHash  String
  role          UserRole    @default(USER)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  legacyPlan    LegacyPlan?
  fundraisers   Fundraiser[]
  memorials     Memorial[]
  activities    Activity[]
}

model LegacyPlan {
  id             String   @id @default(uuid())
  userId         String   @unique
  wishes         String?
  instructions   String?
  assets         Json?
  beneficiaries  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Fundraiser {
  id           String             @id @default(uuid())
  ownerId      String
  title        String
  story        String
  targetAmount Int
  totalRaised  Int                @default(0)
  currency     String             @default("KES")
  status       FundraiserStatus   @default(ACTIVE)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  owner         User                     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  contributions FundraiserContribution[]

  @@index([ownerId])
}

model FundraiserContribution {
  id               String   @id @default(uuid())
  fundraiserId     String
  contributorName  String
  contributorEmail String?
  amount           Int
  message          String?
  createdAt        DateTime @default(now())

  fundraiser Fundraiser @relation(fields: [fundraiserId], references: [id], onDelete: Cascade)

  @@index([fundraiserId])
}

model Memorial {
  id          String   @id @default(uuid())
  ownerId     String
  title       String
  description String?
  coverImage  String?
  isPublic    Boolean  @default(true)
  visibilityType MemorialVisibilityType @default(PUBLIC)
  inviteCode  String?  @unique
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner    User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tributes MemorialTribute[]

  @@index([ownerId])
  @@index([isPublic])
}

model MemorialTribute {
  id         String   @id @default(uuid())
  memorialId String
  authorName String
  message    String
  createdAt  DateTime @default(now())

  memorial Memorial @relation(fields: [memorialId], references: [id], onDelete: Cascade)

  @@index([memorialId])
}

model MarketplaceCategory {
  id       String              @id @default(uuid())
  name     String              @unique
  listings MarketplaceListing[]
}

model MarketplaceListing {
  id          String        @id @default(uuid())
  categoryId  String
  vendorName  String
  title       String
  description String
  imageUrl    String?
  price       Int
  currency    String        @default("KES")
  status      ListingStatus @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  category MarketplaceCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([categoryId])
  @@index([status])
}

model Activity {
  id         String   @id @default(uuid())
  userId     String?
  type       String
  entityType String
  entityId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}
